# 決定論的かつ高性能な物品分類システムのアーキテクチャ設計

## 導入：曖昧性から階層的決定論へ

本レポートの目的は、拾得物管理システムにおける物品分類機能のアーキテクチャを、警察にて規定された「大分類」「中分類」の階層構造に準拠した、高精度なものへと再設計することです。単純なキーワードマッチングから脱却し、バックエンド主導で階層的な分類を決定論的に行う、より高度なエンジンを構築します。

本レポートが提示する中心的な提言は、**分類ロジックをバックエンドへ完全に移管し、表記ゆれを吸収する正規化処理と、現代の物品に対応した豊富なキーワード群を導入すること**です。中核技術としてアホ-コラシック法（Aho-Corasick algorithm）を引き続き利用し、その効率性を最大限に活かします。

提案するアーキテクチャのデータフローは以下の通りです。
1.  ユーザーがReactで構築されたフロントエンドの入力フィールドに品名を入力します。
2.  フロントエンドは入力された文字列をAPIリクエストとしてDjangoバックエンドに送信します。
3.  DjangoのAPIエンドポイントは、まず入力文字列を**正規化（表記ゆれの吸収）**します。
4.  次に、正規化された文字列を、階層情報を持つ事前コンパイル済みのアホ-コラシック・オートマトンを用いて解析します。
5.  このオートマトンのロジックは、現代の製品や通称を網羅するよう大幅に拡張された`item_classification.json`ファイルから生成されます。
6.  分類結果（大分類・中分類を含む）がフロントエンドに返却され、画面に表示されます。

この設計により、システムの精度、頑健性、そして将来的な拡張性が飛躍的に向上します。

## 第1章 基盤：階層的分類を実現する`item_classification.json`の新スキーマ

高精度な階層分類を実現するための根幹は、そのルールを定義する`item_classification.json`のデータ構造にあります。PDFの「大分類 > 中分類 > 小分類」という構造を直接的に表現できる、ネストされたJSONスキーマを引き続き採用します。

### 新スキーマの概念

トップレベルの配列が「大分類」のリストとなり、各大分類オブジェクトが「中分類」オブジェクトのリストを内包します。そして、各中分類オブジェクトが、キーワード（PDFの「小分類」に加え、現代的な用語や同義語を大幅に拡充したもの）のリストを保持します。

この構造により、分類の優先順位（`priority`）を「中分類」レベルで設定でき、よりきめ細やかな競合解決が可能になります。例えば、「カード」という単語を含む品名の場合、「キャッシュカード類」という中分類を、「会員証(カード)類」よりも高く優先する、といった制御が容易になります。

**提案する新スキーマによる`item_classification.json`の実装例：**

```json
[
  {
    "large_category_id": "electronics",
    "large_category_name_ja": "電気製品類",
    "medium_categories": [
      {
        "medium_category_id": "mobile_audio",
        "medium_category_name_ja": "携帯音響品",
        "priority": 78,
        "keywords": [
          { "term": "イヤホン", "weight": 1.0 },
          { "term": "イヤフォン", "weight": 1.0 },
          { "term": "ワイヤレスイヤホン", "weight": 1.2 },
          { "term": "AirPods", "weight": 1.5 },
          { "term": "ヘッドホン", "weight": 1.0 },
          { "term": "ヘッドフォン", "weight": 1.0 },
          { "term": "ヘッドセット", "weight": 1.0 },
          { "term": "MP3プレーヤー", "weight": 1.0 }
        ]
      },
      {
        "medium_category_id": "electronic_devices",
        "medium_category_name_ja": "電子機器",
        "priority": 82,
        "keywords": [
          { "term": "ノートパソコン", "weight": 1.0 },
          { "term": "PC", "weight": 1.0 },
          { "term": "MacBook", "weight": 1.2 },
          { "term": "iPad", "weight": 1.2 },
          { "term": "タブレット", "weight": 1.0 },
          { "term": "電子辞書", "weight": 1.0 },
          { "term": "モバイルバッテリー", "weight": 1.0 }
        ]
      }
    ]
  }
]
```

## 第2章 コアエンジン：正規化処理と階層分類の実装

アルゴリズムの核となるアホ-コラシック法を適用する前に、入力テキストの「表記ゆれ」を吸収するための正規化ステップを導入します。これにより、キーワード辞書を過度に肥大化させることなく、多様な入力に対応できます。

### 正規化層の導入

`ClassificationService`の`classify`メソッドの冒頭で、入力テキストに対して以下の正規化処理を適用します。

1.  **全角・半角の統一**: 全角の英数字、記号、スペースを半角に統一します。
2.  **大文字・小文字の統一**: アルファベットをすべて小文字（または大文字）に統一します。
3.  **カタカナの表記ゆれ補正**: 長音記号「ー」の有無や、「ヴァ」行の表記などをある程度統一するルールを適用します。（例：「コンピューター」→「コンピュータ」）

```python
# pip install mojimoji
import mojimoji

def normalize_text(text: str) -> str:
    """入力テキストを正規化する"""
    # 1. 全角英数字記号を半角に
    text = mojimoji.zen_to_han(text, kana=False)
    # 2. 小文字に統一
    text = text.lower()
    # 3. カタカナの長音を削除するなどの単純な正規化（簡易的な例）
    text = text.replace('ー', '')
    # 必要に応じて他の正規化ルールを追加
    # (例: text = text.replace('ヴァ', 'バ'))
    return text

# ClassificationServiceクラスのclassifyメソッド内
def classify(self, text):
    normalized_text = normalize_text(text)
    found_matches = list(self.automaton.iter(normalized_text))
    # ...以降の処理は同じ...
```
**注記**: `mojimoji`のようなライブラリを利用すると、全角・半角変換を容易に実装できます。

### オートマトンペイロードと分類ロジック

オートマトンに格納するペイロードと、優先度・スコアに基づいて最適な中分類を選択するロジックは、前バージョン（v2）から変更ありません。正規化されたテキストに対して検索を実行する点が唯一の変更点です。

ペイロード構造: `(large_category_id, large_category_name_ja, medium_category_id, medium_category_name_ja, keyword_weight, medium_category_priority)`

このアーキテクチャにより、キーワード辞書に「イヤホン」と「イヤフォン」の両方を登録しつつ、正規化処理によって「ワイヤレスイヤホン」と「ﾜｲﾔﾚｽｲﾔﾎﾝ」のような入力の違いを吸収し、両方のアプローチで精度と頑健性を高めます。

## 第3章 バックエンド統合：Django API

APIのエンドポイント仕様や、Djangoアプリケーション起動時にサービスを初期化する設計に変更はありません。入力された`item_name`を、更新された`ClassificationService`の`classify`メソッドに渡すだけで、正規化処理と高精度な分類が実行されます。

## 第4章 フロントエンド強化：階層表示

フロントエンドのReactコンポーネントも、APIのレスポンス形式（大分類・中分類を含む）に変更はないため、v2から大きな変更は不要です。APIから返された分類結果をユーザーに分かりやすく表示する役割を担います。

## 第5章 結論と戦略的提言

本レポートでは、PDFの分類体系に準拠しつつ、現代の物品に対応するためにキーワードを大幅に拡充し、表記ゆれを吸収する正規化層を導入した、より高精度で頑健な物品分類システムのアーキテクチャを提示しました。

### 今後の展望

**1. 形態素解析との連携強化**
将来的な改善として、現在の正規化処理をさらに発展させ、日本語形態素解析エンジン（例：`SudachiPy`, `Janome`）を導入することが極めて有効です。入力テキストを単語（特に名詞）に分割し、その基本形（見出し語）を抽出してからアホ-コラシック・エンジンに渡すことで、「革製の財布」のような助詞を含む表現や、より複雑な表記ゆれにも対応できるようになります。

**改善後の処理フロー:**
入力: `"失くしたお財布"` → 形態素解析 → `["無くす", "お", "財布"]` → アホ-コラシック・エンジン

**2. 管理画面での階層的キーワード管理**
Django管理画面を拡張し、非開発者が大分類・中分類・キーワード（小分類）・優先度・重みをGUIで安全に編集できる機能を実装することで、システムの運用性とメンテナンス性がさらに向上します。

これらの提言は、本システムを単なる静的なルールベースのツールから、時間と共に成長し、より賢くなる動的なプラットフォームへと進化させるためのロードマップです。
